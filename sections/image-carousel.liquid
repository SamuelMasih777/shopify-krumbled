{% schema %}
{
  "name": "Image Carousel",
  "settings": [
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Speed",
      "default": 4
    },
    {
      "type": "checkbox",
      "id": "enable_autoplay",
      "label": "Enable Autoplay",
      "default": true
    },
    {
      "type": "header",
      "content": "Image Settings"
    },
    {
      "type": "range",
      "id": "image_width",
      "min": 100,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Image Width",
      "default": 250
    },
    {
      "type": "range",
      "id": "image_height",
      "min": 100,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Image Height",
      "default": 250
    },
    {
      "type": "select",
      "id": "image_fit",
      "label": "Image Fit",
      "options": [
        {
          "value": "cover",
          "label": "Cover"
        },
        {
          "value": "contain",
          "label": "Contain"
        },
        {
          "value": "fill",
          "label": "Fill"
        }
      ],
      "default": "cover"
    },
    {
      "type": "header",
      "content": "Highlight & Fade Settings"
    },
    {
      "type": "range",
      "id": "active_opacity",
      "min": 80,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Active Image Opacity",
      "default": 100
    },
    {
      "type": "range",
      "id": "inactive_opacity",
      "min": 20,
      "max": 60,
      "step": 5,
      "unit": "%",
      "label": "Inactive Image Opacity",
      "default": 40
    },
    {
      "type": "range",
      "id": "gap",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Gap Between Images",
      "default": 20
    },
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "padding",
      "min": 20,
      "max": 100,
      "step": 10,
      "unit": "px",
      "label": "Padding",
      "default": 60
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Carousel Alignment",
      "options": [
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "flex-start",
          "label": "Left"
        },
        {
          "value": "flex-end",
          "label": "Right"
        }
      ],
      "default": "center"
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Image Carousel",
      "category": "Image",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}

<style>
.image-carousel-section {
  background-color: {{ section.settings.bg_color }};
  padding: {{ section.settings.padding }}px;
}

.image-carousel-container {
  max-width: 100%;
  margin: 0 auto;
}

.image-carousel-wrapper {
  display: flex;
  align-items: center;
  justify-content: {{ section.settings.alignment }};
  gap: {{ section.settings.gap }}px;
  overflow-x: auto;
  padding: 20px 0;
  scroll-behavior: smooth;
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.image-carousel-wrapper::-webkit-scrollbar {
  display: none;
}

.carousel-image-item {
  flex: 0 0 auto;
  width: {{ section.settings.image_width }}px;
  height: {{ section.settings.image_height }}px;
  border-radius: 12px;
  overflow: hidden;
  cursor: pointer;
  opacity: {{ section.settings.inactive_opacity | times: 0.01 }};
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.carousel-image-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.carousel-image-item img {
  width: 100%;
  height: 100%;
  object-fit: {{ section.settings.image_fit }};
  display: block;
}

.carousel-image-item.active {
  opacity: {{ section.settings.active_opacity | times: 0.01 }};
  transform: scale(1.05);
  box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
}

.carousel-navigation {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin-top: 30px;
  flex-wrap: wrap;
}

.carousel-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: #ddd;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  padding: 0;
}

.carousel-dot:hover {
  background-color: #999;
  transform: scale(1.2);
}

.carousel-dot.active {
  background-color: #333;
  transform: scale(1.3);
}

/* Responsive */
@media (max-width: 768px) {
  .image-carousel-section {
    padding: {{ section.settings.padding | times: 0.6 | round }}px;
  }

  .carousel-image-item {
    width: {{ section.settings.image_width | times: 0.8 | round }}px;
    height: {{ section.settings.image_height | times: 0.8 | round }}px;
  }

  .image-carousel-wrapper {
    gap: {{ section.settings.gap | times: 0.8 | round }}px;
  }
}

@media (max-width: 480px) {
  .image-carousel-section {
    padding: {{ section.settings.padding | times: 0.4 | round }}px;
  }

  .carousel-image-item {
    width: {{ section.settings.image_width | times: 0.6 | round }}px;
    height: {{ section.settings.image_height | times: 0.6 | round }}px;
    border-radius: 8px;
  }

  .image-carousel-wrapper {
    gap: {{ section.settings.gap | times: 0.6 | round }}px;
    padding: 15px 0;
  }

  .carousel-btn {
    width: 32px;
    height: 32px;
    font-size: 14px;
  }

  .carousel-dot {
    width: 8px;
    height: 8px;
  }

  .carousel-navigation {
    margin-top: 20px;
  }
}
</style>

<section class="image-carousel-section">
  <div class="image-carousel-container">
    <div class="image-carousel-wrapper" id="carouselWrapper">
      {% for block in section.blocks %}
        {% if block.settings.image %}
          <div class="carousel-image-item {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}" data-block-id="{{ block.id }}">
            <img 
              src="{{ block.settings.image | image_url: width: 800 }}" 
              alt="Carousel image {{ forloop.index }}"
              width="800"
              height="800"
              loading="lazy">
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="carousel-navigation" id="carouselNav">
      {% for block in section.blocks %}
        {% if block.settings.image %}
          <button 
            class="carousel-dot {% if forloop.first %}active{% endif %}" 
            data-index="{{ forloop.index0 }}"
            aria-label="Go to slide {{ forloop.index }}">
          </button>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const wrapper = document.getElementById('carouselWrapper');
  const items = document.querySelectorAll('.carousel-image-item');
  const dots = document.querySelectorAll('.carousel-dot');

  if (!wrapper || items.length === 0) return;

  let currentIndex = 0;
  let autoplayEnabled = {{ section.settings.enable_autoplay | json }};
  let autoplaySpeed = {{ section.settings.autoplay_speed | times: 1000 }};
  let autoplayInterval;

  function updateCarousel(index) {
    // Update active item
    items.forEach((item, i) => {
      item.classList.toggle('active', i === index);
    });

    // Update active dot
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });

    // Scroll to center the active item
    const activeItem = items[index];
    const wrapperRect = wrapper.getBoundingClientRect();
    const itemRect = activeItem.getBoundingClientRect();
    const scrollLeft = activeItem.offsetLeft - (wrapper.clientWidth / 2) + (activeItem.offsetWidth / 2);
    
    wrapper.scrollTo({
      left: scrollLeft,
      behavior: 'smooth'
    });

    currentIndex = index;
  }

  function nextSlide() {
    const nextIndex = (currentIndex + 1) % items.length;
    updateCarousel(nextIndex);
  }

  function prevSlide() {
    const prevIndex = (currentIndex - 1 + items.length) % items.length;
    updateCarousel(prevIndex);
  }

  function startAutoplay() {
    if (autoplayEnabled) {
      autoplayInterval = setInterval(nextSlide, autoplaySpeed);
    }
  }

  function stopAutoplay() {
    clearInterval(autoplayInterval);
  }

  // Dot navigation
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      updateCarousel(index);
      stopAutoplay();
      if (autoplayEnabled) startAutoplay();
    });
  });

  // Image item click
  items.forEach((item, index) => {
    item.addEventListener('click', () => {
      updateCarousel(index);
      stopAutoplay();
      if (autoplayEnabled) startAutoplay();
    });
  });

  // Pause on hover
  wrapper.addEventListener('mouseenter', stopAutoplay);
  wrapper.addEventListener('mouseleave', () => {
    if (autoplayEnabled) startAutoplay();
  });

  // Start autoplay
  startAutoplay();
});
</script>
