{% schema %}
{
  "name": "Media Carousel",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Lemon Coconut Beauty Bites® 11 x 32g In Action"
    },
    {
      "type": "font_picker",
      "id": "title_font",
      "label": "Title Font",
      "default": "serif"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 24,
      "max": 72,
      "step": 2,
      "unit": "px",
      "label": "Title Size",
      "default": 48
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#1a1a1a"
    },
    {
      "type": "range",
      "id": "title_margin_bottom",
      "min": 20,
      "max": 80,
      "step": 10,
      "unit": "px",
      "label": "Title Bottom Margin",
      "default": 50
    },
    {
      "type": "range",
      "id": "section_padding",
      "min": 40,
      "max": 120,
      "step": 10,
      "unit": "px",
      "label": "Section Padding",
      "default": 80
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "range",
      "id": "carousel_height",
      "min": 300,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Carousel Height",
      "default": 500
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2,
      "max": 10,
      "step": 0.5,
      "unit": "s",
      "label": "Autoplay Speed",
      "default": 5
    },
    {
      "type": "range",
      "id": "transition_speed",
      "min": 0.3,
      "max": 2,
      "step": 0.1,
      "unit": "s",
      "label": "Transition Speed",
      "default": 0.8
    },
    {
      "type": "range",
      "id": "item_gap",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Gap Between Items",
      "default": 20
    },
    {
      "type": "header",
      "content": "Carousel Items Per View"
    },
    {
      "type": "range",
      "id": "desktop_items",
      "min": 1,
      "max": 6,
      "step": 1,
      "label": "Desktop Items",
      "default": 5
    },
    {
      "type": "range",
      "id": "tablet_items",
      "min": 1,
      "max": 5,
      "step": 1,
      "label": "Tablet Items",
      "default": 3
    },
    {
      "type": "range",
      "id": "mobile_items",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Mobile Items",
      "default": 1
    },
    {
      "type": "header",
      "content": "Dot Navigation"
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show Dot Navigation",
      "default": true
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot Color",
      "default": "#cccccc"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Active Dot Color",
      "default": "#1a1a1a"
    },
    {
      "type": "range",
      "id": "dot_size",
      "min": 6,
      "max": 16,
      "step": 1,
      "unit": "px",
      "label": "Dot Size",
      "default": 10
    }
  ],
  "blocks": [
    {
      "type": "media_item",
      "name": "Media Item",
      "settings": [
        {
          "type": "header",
          "content": "Media Settings"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image or GIF"
        },
        {
          "type": "text",
          "id": "video_url",
          "label": "Video URL (MP4/WebM)",
          "info": "Leave empty to use image instead"
        },
        {
          "type": "header",
          "content": "Overlay Text (Optional)"
        },
        {
          "type": "text",
          "id": "overlay_text",
          "label": "Overlay Text"
        },
        {
          "type": "color",
          "id": "overlay_text_color",
          "label": "Text Color",
          "default": "#ffffff"
        },
        {
          "type": "range",
          "id": "overlay_text_size",
          "min": 10,
          "max": 24,
          "step": 1,
          "unit": "px",
          "label": "Text Size",
          "default": 14
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Media Carousel",
      "settings": {
        "section_title": "Lemon Coconut Beauty Bites® 11 x 32g In Action"
      },
      "blocks": [
        {
          "type": "media_item"
        },
        {
          "type": "media_item"
        },
        {
          "type": "media_item"
        },
        {
          "type": "media_item"
        },
        {
          "type": "media_item",
          "settings": {
            "overlay_text": "Packed with hydrolysed collagen and vitamins"
          }
        }
      ]
    }
  ]
}
{% endschema %}

<style>
.media-carousel-section {
  padding: {{ section.settings.section_padding }}px 40px;
  background-color: {{ section.settings.bg_color }};
}

.media-carousel-wrapper {
  max-width: 1600px;
  margin: 0 auto;
}

.media-carousel-title {
  font-family: {{ section.settings.title_font.family }}, {{ section.settings.title_font.fallback_families }};
  font-size: {{ section.settings.title_size }}px;
  font-weight: 400;
  color: {{ section.settings.title_color }};
  margin: 0 0 {{ section.settings.title_margin_bottom }}px 0;
  line-height: 1.2;
  letter-spacing: -0.5px;
  text-align: center;
}

/* Carousel Container */
.carousel-container {
  position: relative;
  width: 100%;
  overflow: hidden;
  border-radius: 12px;
}

.carousel-track {
  display: flex;
  height: {{ section.settings.carousel_height }}px;
  gap: {{ section.settings.item_gap }}px;
  overflow-x: auto;
  scroll-behavior: smooth;
  scrollbar-width: none;
  -ms-overflow-style: none;
  padding: 0;
  margin: 0;
  list-style: none;
}

.carousel-track::-webkit-scrollbar {
  display: none;
}

.carousel-item {
  flex: 0 0 calc((100% - ({{ section.settings.desktop_items | minus: 1 }} * {{ section.settings.item_gap }}px)) / {{ section.settings.desktop_items }});
  min-height: {{ section.settings.carousel_height }}px;
  border-radius: 8px;
  overflow: hidden;
  position: relative;
  background: #f0f0f0;
  transition: all {{ section.settings.transition_speed }}s ease;
  cursor: pointer;
}

.carousel-item:hover {
  transform: scale(1.02);
}

.carousel-item-media {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.carousel-item-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Overlay Text */
.carousel-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  top: 0;
  display: flex;
  align-items: flex-end;
  padding: 20px;
  background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.4) 40%, transparent 100%);
  opacity: 0;
  transition: opacity {{ section.settings.transition_speed }}s ease;
}

.carousel-item:hover .carousel-overlay {
  opacity: 1;
}

.carousel-overlay-text {
  color: {{ section.settings.dot_active_color }};
  font-size: 14px;
  font-weight: 500;
  line-height: 1.4;
  max-width: 100%;
  word-break: break-word;
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 12px;
  border-radius: 4px;
  color: #333;
}

/* Placeholder */
.carousel-placeholder {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #999;
  font-size: 14px;
  text-align: center;
  padding: 20px;
}

/* Dot Navigation */
.carousel-dots {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 30px;
  flex-wrap: wrap;
}

.carousel-dot {
  width: {{ section.settings.dot_size }}px;
  height: {{ section.settings.dot_size }}px;
  border-radius: 50%;
  background-color: {{ section.settings.dot_color }};
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
  padding: 0;
  display: inline-block;
}

.carousel-dot:hover {
  transform: scale(1.2);
}

.carousel-dot.active {
  background-color: {{ section.settings.dot_active_color }};
  transform: scale(1.3);
}

/* Responsive Design */
@media (max-width: 1200px) {
  .media-carousel-section {
    padding: {{ section.settings.section_padding | minus: 20 }}px 30px;
  }

  .media-carousel-title {
    font-size: clamp(32px, 6vw, {{ section.settings.title_size }}px);
    margin-bottom: {{ section.settings.title_margin_bottom | minus: 10 }}px;
  }

  .carousel-item {
    flex: 0 0 calc((100% - ({{ section.settings.tablet_items | minus: 1 }} * {{ section.settings.item_gap }}px)) / {{ section.settings.tablet_items }});
  }
}

@media (max-width: 768px) {
  .media-carousel-section {
    padding: {{ section.settings.section_padding | minus: 30 }}px 20px;
  }

  .media-carousel-title {
    font-size: clamp(24px, 7vw, 42px);
    margin-bottom: {{ section.settings.title_margin_bottom | minus: 20 }}px;
  }

  .carousel-track {
    height: {{ section.settings.carousel_height | minus: 100 }}px;
  }

  .carousel-item {
    flex: 0 0 calc((100% - ({{ section.settings.mobile_items | minus: 1 }} * {{ section.settings.item_gap }}px)) / {{ section.settings.mobile_items }});
    min-height: {{ section.settings.carousel_height | minus: 100 }}px;
  }

  .carousel-overlay-text {
    font-size: 12px;
    padding: 6px 10px;
  }
}

@media (max-width: 480px) {
  .media-carousel-section {
    padding: 40px 15px;
  }

  .media-carousel-title {
    font-size: 22px;
    margin-bottom: 25px;
  }

  .carousel-track {
    height: {{ section.settings.carousel_height | minus: 150 }}px;
  }

  .carousel-item {
    flex: 0 0 100%;
    min-height: {{ section.settings.carousel_height | minus: 150 }}px;
  }

  .carousel-dots {
    gap: 8px;
    margin-top: 20px;
  }

  .carousel-dot {
    width: {{ section.settings.dot_size | minus: 2 }}px;
    height: {{ section.settings.dot_size | minus: 2 }}px;
  }
}

/* Animation */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.media-carousel-title {
  animation: slideIn 0.6s ease-out;
}

.carousel-item {
  animation: slideIn 0.6s ease-out;
}
</style>

<section class="media-carousel-section">
  <div class="media-carousel-wrapper">
    {% if section.settings.section_title %}
      <h2 class="media-carousel-title">{{ section.settings.section_title }}</h2>
    {% endif %}

    <div class="carousel-container">
      <div class="carousel-track" id="carouselTrack">
        {% for block in section.blocks %}
          {% if block.type == 'media_item' %}
            <div class="carousel-item" {{ block.shopify_attributes }}>
              {% if block.settings.video_url != blank %}
                <video class="carousel-item-video" autoplay muted loop playsinline>
                  <source src="{{ block.settings.video_url }}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              {% elsif block.settings.image %}
                <img src="{{ block.settings.image | image_url: width: 800 }}" alt="Media" class="carousel-item-media" loading="lazy" width="800" height="500">
              {% else %}
                <div class="carousel-placeholder">
                  <div>
                    <p style="margin: 0 0 10px 0; font-weight: 500;">Add Media</p>
                    <p style="margin: 0; font-size: 12px;">Image or Video</p>
                  </div>
                </div>
              {% endif %}

              {% if block.settings.overlay_text != blank %}
                <div class="carousel-overlay">
                  <div class="carousel-overlay-text">{{ block.settings.overlay_text }}</div>
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    {% if section.settings.show_dots %}
      <div class="carousel-dots" id="carouselDots"></div>
    {% endif %}
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const carouselTrack = document.getElementById('carouselTrack');
  const carouselDots = document.getElementById('carouselDots');
  const carouselItems = document.querySelectorAll('.carousel-item');
  
  if (!carouselTrack || carouselItems.length === 0) return;

  const autoplaySpeed = {{ section.settings.autoplay_speed | times: 1000 }};
  const desktopItems = {{ section.settings.desktop_items }};
  const tabletItems = {{ section.settings.tablet_items }};
  const mobileItems = {{ section.settings.mobile_items }};

  let currentIndex = 0;
  let autoplayInterval;
  let itemsPerView = desktopItems;

  // Determine items per view based on screen size
  function updateItemsPerView() {
    if (window.innerWidth <= 480) {
      itemsPerView = mobileItems;
    } else if (window.innerWidth <= 768) {
      itemsPerView = tabletItems;
    } else {
      itemsPerView = desktopItems;
    }
  }

  // Create dots
  function createDots() {
    carouselDots.innerHTML = '';
    const totalPages = Math.ceil(carouselItems.length / itemsPerView);
    
    for (let i = 0; i < totalPages; i++) {
      const dot = document.createElement('button');
      dot.className = 'carousel-dot';
      if (i === 0) dot.classList.add('active');
      dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
      
      dot.addEventListener('click', () => {
        currentIndex = i;
        scrollToIndex();
        resetAutoplay();
      });
      
      carouselDots.appendChild(dot);
    }
  }

  // Scroll to index
  function scrollToIndex() {
    const itemWidth = carouselItems[0].offsetWidth;
    const gap = {{ section.settings.item_gap }};
    const scrollLeft = (itemWidth + gap) * currentIndex;
    
    carouselTrack.scrollLeft = scrollLeft;
    updateActiveDot();
  }

  // Update active dot
  function updateActiveDot() {
    const dots = document.querySelectorAll('.carousel-dot');
    dots.forEach((dot, index) => {
      dot.classList.toggle('active', index === Math.floor(currentIndex / itemsPerView));
    });
  }

  // Auto-scroll
  function autoScroll() {
    currentIndex++;
    const maxIndex = Math.ceil(carouselItems.length / itemsPerView) - 1;
    
    if (currentIndex > maxIndex) {
      currentIndex = 0;
    }
    
    scrollToIndex();
  }

  // Reset autoplay
  function resetAutoplay() {
    clearInterval(autoplayInterval);
    autoplayInterval = setInterval(autoScroll, autoplaySpeed);
  }

  // Pause on hover
  carouselTrack.addEventListener('mouseenter', () => {
    clearInterval(autoplayInterval);
  });

  carouselTrack.addEventListener('mouseleave', () => {
    resetAutoplay();
  });

  // Handle scroll manually
  let scrollTimeout;
  carouselTrack.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    clearInterval(autoplayInterval);
    
    scrollTimeout = setTimeout(() => {
      resetAutoplay();
    }, 1000);
  });

  // Handle window resize
  window.addEventListener('resize', () => {
    updateItemsPerView();
    createDots();
    currentIndex = 0;
    scrollToIndex();
  });

  // Initialize
  updateItemsPerView();
  createDots();
  resetAutoplay();

  // Update dots on scroll position
  carouselTrack.addEventListener('scroll', updateActiveDot, { passive: true });
});
</script>
