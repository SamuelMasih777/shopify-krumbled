{% comment %}
  Renders a Mega Menu with a Sidebar and 4 Product Cards.
  Accepts:
  - sidebar_menu: LinkList handle
  - sidebar_heading: Text for sidebar title
  - sidebar_link: URL for sidebar title
  - product_1: Product object
  - product_2: Product object
  - product_3: Product object
  - product_4: Product object
  - brand_color: Color string for accents
{% endcomment %}

<div class="mega-menu-inner">
  <!-- Left Sidebar (Menu) -->
  <div class="mega-menu-sidebar">
    {% if sidebar_heading != blank %}
      <div class="mega-menu-heading-wrap" style="margin-bottom:15px;">
        {% if sidebar_link != blank %}
          <a href="{{ sidebar_link }}" class="mega-menu-heading" style="color:{{ brand_color }}; font-weight:700; text-transform:uppercase; text-decoration:none; font-size:14px; letter-spacing:1px;">{{ sidebar_heading }}</a>
        {% else %}
           <span class="mega-menu-heading" style="color:{{ brand_color }}; font-weight:700; text-transform:uppercase; font-size:14px; letter-spacing:1px;">{{ sidebar_heading }}</span>
        {% endif %}
      </div>
    {% endif %}

    {% if sidebar_items != blank %}
      <ul>
        {% assign items = sidebar_items | newline_to_br | split: '<br />' %}
        {% for item in items %}
          {% assign parts = item | split: '|' %}
          {% assign title = parts[0] | strip %}
          {% assign url = parts[1] | strip %}
          {% if title != blank %}
            <li>
              <a href="{{ url | default: '#' }}" class="mega-sidebar-link">{{ title }}</a>
            </li>
          {% endif %}
        {% endfor %}
      </ul>
    {% elsif sidebar_menu != blank %}
      <ul>
        {% for link in linklists[sidebar_menu].links %}
          <li>
            <a href="{{ link.url }}" class="mega-sidebar-link">{{ link.title }}</a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="placeholder-text">Enter "Title | URL" in Sidebar Items settings</p>
    {% endif %}
  </div>

  <!-- Right Product Grid -->
  <div class="mega-menu-products">
    {% assign active_count = 0 %}
    
    {% comment %} Helper to render product card {% endcomment %}
    {% capture product_cards %}
      {% for i in (1..4) %}
        {% assign handle_var = 'product_' | append: i %}
        {% assign handle_val = [handle_var] %} <!-- Access variable dynamically? No, liquid doesn't support indirect var access easily in this scope context without passed args being cleaner -->
        
        {% comment %} Manual checks since dynamic var access is hard {% endcomment %}
        {% assign current_handle = blank %}
        {% if i == 1 %}{% assign current_handle = product_1 %}{% endif %}
        {% if i == 2 %}{% assign current_handle = product_2 %}{% endif %}
        {% if i == 3 %}{% assign current_handle = product_3 %}{% endif %}
        {% if i == 4 %}{% assign current_handle = product_4 %}{% endif %}

        {% if current_handle != blank %}
          {% assign prod = all_products[current_handle] %}
          {% if prod == empty %}{% assign prod = current_handle %}{% endif %}
          
          {% if prod.featured_image != blank or prod.title != blank %}
            {% assign active_count = active_count | plus: 1 %}
            <div class="mega-product-card">
              <a href="{{ prod.url }}" class="product-link">
                <div class="product-image-wrap">
                  <img src="{{ prod.featured_image | image_url: width: 300 }}" alt="{{ prod.title }}" loading="lazy">
                </div>
                <div class="product-info">
                  <span class="product-title">{{ prod.title }}</span>
                </div>
              </a>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endcapture %}

    {% if active_count > 0 %}
      {{ product_cards }}
    {% else %}
      <!-- Placeholders if no products selected -->
      {% for i in (1..4) %}
        <div class="mega-product-card placeholder">
           <div class="product-image-wrap placeholder-image">
             <span>Product {{ i }}</span>
           </div>
           <div class="product-info">
             <span class="product-title">Product Name</span>
             <span class="product-price">$00.00</span>
           </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>
</div>
