{% schema %}
{
  "name": "Krumbled Product",
  "settings": [
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 1000,
      "max": 1600,
      "step": 50,
      "unit": "px",
      "label": "Container Width",
      "default": 1300
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "font_picker",
      "id": "heading_font",
      "label": "Heading Font",
      "default": "serif"
    },
    {
      "type": "font_picker",
      "id": "body_font",
      "label": "Body Font",
      "default": "sans-serif"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#111111"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color (Buttons/Sale)",
      "default": "#e9427c"
    },
    {
      "type": "color",
      "id": "price_color",
      "label": "Price Color",
      "default": "#111111"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "product_tag_label",
      "label": "Product Tag Label",
      "default": "COLLAGEN POWDER"
    }
  ],
  "presets": [
    {
      "name": "Krumbled Product Page"
    }
  ]
}
{% endschema %}

<style>
  {{ section.settings.heading_font | font_face }}
  {{ section.settings.body_font | font_face }}

  .krumbled-product-section {
    background-color: {{ section.settings.bg_color }};
    padding: 60px 20px;
    font-family: {{ section.settings.body_font.family }}, {{ section.settings.body_font.fallback_families }};
    color: {{ section.settings.text_color }};
  }

  .kp-container {
    max-width: {{ section.settings.container_width }}px;
    margin: 0 auto;
  }

  /* Breadcrumbs */
  .kp-breadcrumbs {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 40px;
    color: #666;
  }
  .kp-breadcrumbs a {
    text-decoration: none;
    color: inherit;
    transition: color 0.3s;
  }
  .kp-breadcrumbs a:hover {
    color: {{ section.settings.accent_color }};
  }
  .kp-breadcrumbs span {
    margin: 0 8px;
    color: #ccc;
  }

  /* Grid Layout */
  .kp-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 60px;
    align-items: start;
  }

  /* Gallery */
  .kp-gallery {
    display: flex;
    gap: 20px;
  }
  .kp-thumbnails {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 80px;
    flex-shrink: 0;
  }
  .kp-thumb {
    width: 100%;
    aspect-ratio: 1;
    border-radius: 8px;
    cursor: pointer;
    overflow: hidden;
    border: 2px solid transparent;
    transition: border-color 0.3s;
  }
  .kp-thumb.active {
    border-color: {{ section.settings.accent_color }};
  }
  .kp-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .kp-main-image {
    flex-grow: 1;
    border-radius: 12px;
    overflow: hidden;
    background: #f9f9f9;
  }
  .kp-main-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  /* Product Info */
  .kp-info {
    position: sticky;
    top: 40px;
    text-align: {{ section.settings.text_alignment }};
  }
  
  .kp-tag {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 15px;
    display: block;
    color: #666;
  }

  .kp-title {
    font-family: {{ section.settings.heading_font.family }}, serif;
    font-weight: 400; /* Often lighter in elegant designs */
    font-size: 48px;
    line-height: 1.1;
    margin-bottom: 15px;
  }

  .kp-reviews {
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: {% if section.settings.text_alignment == 'center' %}center{% else %}flex-start{% endif %};
  }
  .kp-stars { color: #f4b619; }
  .kp-review-count { font-size: 14px; color: #666; }

  .kp-description {
    line-height: 1.6;
    color: #444;
    margin-bottom: 30px;
    font-size: 16px;
  }

  .kp-price-box {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    justify-content: {% if section.settings.text_alignment == 'center' %}center{% else %}flex-start{% endif %};
  }
  .kp-price {
    font-size: 24px;
    font-weight: 600;
    color: {{ section.settings.price_color }};
  }
  .kp-compare-price {
    font-size: 18px;
    text-decoration: line-through;
    color: #999;
  }
  .kp-sale-badge {
    background: {{ section.settings.accent_color }};
    color: #fff;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
  }

  .kp-actions {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
    justify-content: {% if section.settings.text_alignment == 'center' %}center{% else %}flex-start{% endif %};
  }

  /* Quantity Selector */
  .kp-quantity {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 6px;
    height: 50px;
    width: 120px;
    background: #f9f9f9;
  }
  .kp-qty-btn {
    width: 40px;
    height: 100%;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 18px;
    color: #333;
  }
  .kp-qty-input {
    width: 40px;
    height: 100%;
    border: none;
    background: transparent;
    text-align: center;
    font-weight: 600;
  }
  .kp-qty-input:focus { outline: none; }

  /* Add to Cart */
  .kp-add-to-cart {
    flex-grow: 1;
    background: {{ section.settings.accent_color }};
    color: #fff;
    border: none;
    height: 50px;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    transition: opacity 0.3s;
    text-transform: uppercase;
  }
  .kp-add-to-cart:hover {
    opacity: 0.9;
  }

  .kp-payment-terms {
    font-size: 13px;
    color: #666;
    display: flex;
    align-items: center;
    gap: 5px;
    justify-content: {% if section.settings.text_alignment == 'center' %}center{% else %}flex-start{% endif %};
  }

  @media (max-width: 900px) {
    .kp-grid {
      grid-template-columns: 1fr;
      gap: 30px;
    }
    .kp-gallery {
      flex-direction: column-reverse; /* Thumbnails below on mobile if preferred, or keep side */
    }
    .kp-info {
      position: static;
    }
    .kp-title {
      font-size: 32px;
    }
  }
</style>

<div class="krumbled-product-section">
  <div class="kp-container">
    <!-- Breadcrumbs -->
    <nav class="kp-breadcrumbs">
      <a href="/">HOME</a>
      <span>|</span>
      <a href="/collections/all">BEST SELLING</a>
      <span>|</span>
      <span>{{ product.title | upcase }}</span>
    </nav>

    <div class="kp-grid">
      <!-- Left: Gallery -->
      <div class="kp-gallery">
        <div class="kp-thumbnails">
          {% for media in product.media %}
            <div class="kp-thumb {% if forloop.first %}active{% endif %}" onclick="changeImage('{{ media.preview_image | image_url: width: 1000 }}', this)">
              <img src="{{ media.preview_image | image_url: width: 150, height: 150, crop: 'center' }}" alt="{{ media.alt | escape }}">
            </div>
          {% endfor %}
        </div>
        <div class="kp-main-image">
          <img id="mainImage" src="{{ product.featured_image | image_url: width: 1000 }}" alt="{{ product.title | escape }}">
        </div>
      </div>

      <!-- Right: Info -->
      <div class="kp-info">
        <span class="kp-tag">{{ section.settings.product_tag_label }}</span>
        
        <h1 class="kp-title">{{ product.title }}</h1>

        <!-- Reviews Placeholder (using static stars or app integration) -->
        <div class="kp-reviews">
          <div class="kp-stars">★★★★★</div>
          <span class="kp-review-count">148 Reviews</span> 
        </div>

        <div class="kp-description">
          {{ product.description | strip_html | truncatewords: 30 }}
        </div>

        <div class="kp-price-box">
          <span class="kp-compare-price">{{ product.compare_at_price | money }}</span>
          <span class="kp-price">{{ product.price | money }}</span>
          {% if product.compare_at_price > product.price %}
            <span class="kp-sale-badge">Sale</span>
          {% endif %}
        </div>

        {% form 'product', product %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
          
          <div class="kp-actions">
            <!-- Quantity -->
            <div class="kp-quantity">
              <button type="button" class="kp-qty-btn" onclick="updateQty(-1)">−</button>
              <input type="number" id="qtyInput" name="quantity" value="1" min="1" class="kp-qty-input">
              <button type="button" class="kp-qty-btn" onclick="updateQty(1)">+</button>
            </div>
            
            <!-- Add to Cart -->
            <button type="submit" class="kp-add-to-cart">
              Add to Cart
            </button>
          </div>
        {% endform %}

        <div class="kp-payment-terms">
          or 4 interest-free payments of {{ product.price | divided_by: 4 | money }} with <strong>afterpay</strong> ⓘ
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function changeImage(src, thumbElement) {
    document.getElementById('mainImage').src = src;
    
    // Update active class
    document.querySelectorAll('.kp-thumb').forEach(el => el.classList.remove('active'));
    thumbElement.classList.add('active');
  }

  function updateQty(change) {
    const input = document.getElementById('qtyInput');
    let newVal = parseInt(input.value) + change;
    if (newVal < 1) newVal = 1;
    input.value = newVal;
  }
</script>
